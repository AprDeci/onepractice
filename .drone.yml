kind: pipeline
type: docker
name: default

trigger:
  branch:
    - droneCi
  event:
    - push


#构建过程 maven build 推送构件
steps:
  - name: test and build
    image: docker.1ms.run/maven:3.9.10-eclipse-temurin-21-alpine
    environment: # 从Secrets注入环境变量
      APP_CONFIG_URL:
        from_secret: APP_CONFIG_URL
      PROD_CONFIG_URL:
        from_secret: PROD_CONFIG_URL
    commands:
      - wget ${APP_CONFIG_URL} -O src/main/resources/application.yml
      - wget ${PROD_CONFIG_URL} -O src/main/resources/application-prod.yml
      - echo "------------------------------start test----------------------------------"
      - mvn clean test -P prod
      - echo "------------------------------start package----------------------------------"
      - mvn package -P prod
    volumes:
      - name: maven-cache
        path: /root/.m2

  - name: upload r2
    image: plugins/s3
    settings:
      bucket: onepractice
      endpoint:
        from_secret: R2_ENDPOINT
      access_key:
        from_secret: R2_ACCESS_KEY
      secret_key:
        from_secret: R2_SERCRET_KEY
      region: APAC
      strip_prefix: /drone/src/target/
      source: /drone/src/target/*.jar
      target: /


  - name: ssh
    image: appleboy/drone-ssh
    settings:
      host:
        from_secret: DEPLOYIP
      username:
        from_secret: DEPLOYUSERNAME
      password:
          from_secret: DEPLOYPASSWORD
      port: 22
      command_timeout: 2m
      script:
        - /home/onepractice/run.sh

volumes:
  - name: maven-cache
    host:
      path: /data/cache/maven